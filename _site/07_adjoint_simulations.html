<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>SPECFEM3D_Cartesian</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=e01eaeac25bebaede87fee4bc75f9f27dc55c330">
  </head>
  <body>
    <section class="page-header">
      <div class="parallax"><!-- parallax -->
        <div class="parallax_layer parallax_layer_back">
          <div class="img_background img1"></div>
        </div>
      <!-- </div> -->
      <div class="parallax_layer parallax_layer_front">
        <h1 class="project-name">SPECFEM3D_Cartesian</h1>
        <h2 class="project-tagline">SPECFEM3D_Cartesian simulates acoustic (fluid), elastic (solid), coupled acoustic/elastic, poroelastic or seismic wave propagation in any type of conforming mesh of hexahedra (structured or not.)
</h2>
        
          <a href="http://github.com/danielpeter/specfem3d" class="btn">View on GitHub</a>
        
        
      </div><!-- end of parallax -->
    </section>

    <section class="main-content">
      <p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="#adjoint-simulations">Adjoint Simulations</a>
    <ul>
      <li><a href="#adjoint-simulations-for-sources-only-not-for-the-model">Adjoint Simulations for Sources Only (not for the Model)</a></li>
      <li><a href="#adjoint-simulations-for-finite-frequency-kernels-kernel-simulation">Adjoint Simulations for Finite-Frequency Kernels (Kernel Simulation)</a></li>
    </ul>
  </li>
</ul>

<h1 id="adjoint-simulations">Adjoint Simulations</h1>

<p>Adjoint simulations are generally performed for two distinct applications. First, they can be used in point source moment-tensor inversions, or source imaging for earthquakes with large ruptures such as the Lander’s earthquake (Wald and Heaton 1994). Second, they can be used to generate finite-frequency sensitivity kernels that are a critical part of tomographic inversions based upon 3D reference models (J. Tromp, Tape, and Liu 2005; Liu and Tromp 2006; J. Tromp, Komatitsch, and Liu 2008; Q. Liu and Tromp 2008). In either case, source parameter or velocity structure updates are sought to minimize a specific misfit function (e.g., waveform or traveltime differences), and the adjoint simulation provides a means of computing the gradient of the misfit function and further reducing it in successive iterations. Applications and procedures pertaining to source studies and finite-frequency kernels are discussed in Sections [sec:Adjoint-simulation-sources] and [sec:Adjoint-simulation-finite], respectively. The two related parameters in the <code class="highlighter-rouge">Par_file</code> are <code class="highlighter-rouge">SIMULATION_TYPE</code> (1, 2 or 3) and the <code class="highlighter-rouge">SAVE_FORWARD</code> (boolean).</p>

<h2 id="adjoint-simulations-for-sources-only-not-for-the-model">Adjoint Simulations for Sources Only (not for the Model)</h2>

<p>When a specific misfit function between data and synthetics is minimized to invert for earthquake source parameters, the gradient of the misfit function with respect to these source parameters can be computed by placing time-reversed seismograms at the receivers as virtual sources in an adjoint simulation. Then the value of the gradient is obtained from the adjoint seismograms recorded at the original earthquake location.</p>

<ol>
  <li>
    <p><strong>Prepare the adjoint sources</strong> [enu:Prepare-the-adjoint]</p>

    <ol>
      <li>
        <p>First, run a regular forward simulation (<code class="highlighter-rouge">SIMULATION_TYPE = 1</code> and <code class="highlighter-rouge">SAVE_FORWARD = .false.</code>). You can automatically set these two variables using the <code class="highlighter-rouge">utils/change_simulation_type.pl</code><span> script:</span></p>

        <div class="highlighter-rouge"><pre class="highlight"><code>utils/change_simulation_type.pl -f
</code></pre>
        </div>

        <p>and then collect the recorded seismograms at all the stations given in <code class="highlighter-rouge">DATA/STATIONS</code>.</p>
      </li>
      <li>
        <p>Then select the stations for which you want to compute the time-reversed adjoint sources and run the adjoint simulation, and compile them into the <code class="highlighter-rouge">DATA/STATIONS_ADJOINT</code> file, which has the same format as the regular <code class="highlighter-rouge">DATA/STATIONS</code> file.</p>

        <ul>
          <li>
            <p>Depending on what type of misfit function is used for the source inversion, adjoint sources need to be computed from the original recorded seismograms for the selected stations and saved in a sub-directory called <code class="highlighter-rouge">SEM/</code> in the root directory of the code, with the format <code class="highlighter-rouge">NT.STA.BX?.adj</code>, where <code class="highlighter-rouge">NT</code>, <code class="highlighter-rouge">STA</code> are the network code and station name given in the <code class="highlighter-rouge">DATA/STATIONS_ADJOINT</code> file, and <code class="highlighter-rouge">BX?</code> represents the component name of a particular adjoint seismogram. Please note that the band code can change depending on your sampling rate (see Appendix [cha:channel-codes] for further details).</p>
          </li>
          <li>
            <p>The adjoint seismograms are in the same format as the original seismogram (<code class="highlighter-rouge">NT.STA.BX?.sem?</code>), with the same start time, time interval and record length.</p>
          </li>
        </ul>
      </li>
      <li>
        <p>Notice that even if you choose to time reverse only one component from one specific station, you still need to supply all three components because the code is expecting them (you can set the other two components to be zero).</p>
      </li>
      <li>
        <p>Also note that since time-reversal is done in the code itself, no explicit time-reversing is needed for the preparation of the adjoint sources, i.e., the adjoint sources are in the same forward time sense as the original recorded seismograms.</p>
      </li>
    </ol>
  </li>
  <li>
    <p><strong>Set the related parameters and run the adjoint simulation</strong>
In the <code class="highlighter-rouge">DATA/Par_file</code>, set the two related parameters to be <code class="highlighter-rouge">SIMULATION_TYPE = 2</code> and <code class="highlighter-rouge">SAVE_FORWARD = .false.</code>. More conveniently, use the scripts <code class="highlighter-rouge">utils/change_simulation_type.pl</code> to modify the <code class="highlighter-rouge">Par_file</code> automatically (<code class="highlighter-rouge">change_simulation_type.pl -a</code>). Then run the solver to launch the adjoint simulation.</p>
  </li>
  <li>
    <p><strong>Collect the seismograms at the original source location</strong></p>

    <p>After the adjoint simulation has completed successfully, collect the seismograms from <code class="highlighter-rouge">LOCAL_PATH</code>.</p>

    <ul>
      <li>
        <p>These adjoint seismograms are recorded at the locations of the original earthquake sources given by the <code class="highlighter-rouge">DATA/CMTSOLUTION</code> file, and have names of the form <code class="highlighter-rouge">NT.S?????.S??.sem</code> for the six-component strain tensor (<code class="highlighter-rouge">SNN,SEE,SZZ,SNE,SNZ,SEZ</code>) at these locations, and
<code class="highlighter-rouge">NT.S?????.BX?.sem</code> for the three-component displacements (<code class="highlighter-rouge">BXN,BXE,BXZ</code>) recorded at these locations.</p>
      </li>
      <li>
        <p><code class="highlighter-rouge">S?????</code> denotes the source number; for example, if the original <code class="highlighter-rouge">CMTSOLUTION</code> provides only a point source, then the seismograms collected will start with <code class="highlighter-rouge">S00001</code>.</p>
      </li>
      <li>
        <p>These adjoint seismograms provide critical information for the computation of the gradient of the misfit function.</p>
      </li>
    </ul>
  </li>
</ol>

<h2 id="adjoint-simulations-for-finite-frequency-kernels-kernel-simulation">Adjoint Simulations for Finite-Frequency Kernels (Kernel Simulation)</h2>

<p>Finite-frequency sensitivity kernels are computed in two successive simulations (please refer to Liu and Tromp (2006) and J. Tromp, Komatitsch, and Liu (2008) for details).</p>

<ol>
  <li>
    <p><strong>Run a forward simulation with the state variables saved at the end of the simulation</strong></p>

    <p>Prepare the <code class="highlighter-rouge">CMTSOLUTION</code><span> and </span><code class="highlighter-rouge">STATIONS</code><span> files, set the parameters </span><code class="highlighter-rouge">SIMULATION_TYPE</code><span> </span><code class="highlighter-rouge">=</code><span> </span><code class="highlighter-rouge">1</code><span> and </span><code class="highlighter-rouge">SAVE_FORWARD =</code><span> </span><code class="highlighter-rouge">.true.</code><span> in the </span><code class="highlighter-rouge">Par_file</code><span> (</span><code class="highlighter-rouge">change_simulation_type -F</code><span>), and run the solver.</span></p>

    <ul>
      <li>
        <p>Notice that attenuation is not implemented yet for the computation of finite-frequency kernels; therefore set <code class="highlighter-rouge">ATTENUATION = .false.</code> in the <code class="highlighter-rouge">Par_file</code>.</p>
      </li>
      <li>
        <p>We also suggest you modify the half duration of the <code class="highlighter-rouge">CMTSOLUTION</code> to be similar to the accuracy of the simulation (see Equation [eq:shortest<sub>p</sub>eriod]) to avoid too much high-frequency noise in the forward wavefield, although theoretically the high-frequency noise should be eliminated when convolved with an adjoint wavefield with the proper frequency content.</p>
      </li>
      <li>
        <p>This forward simulation differs from the regular simulations (<code class="highlighter-rouge">SIMULATION_TYPE</code><span> </span><code class="highlighter-rouge">=</code><span> </span><code class="highlighter-rouge">1</code><span> and </span><code class="highlighter-rouge">SAVE_FORWARD</code><span> </span><code class="highlighter-rouge">=</code><span> </span><code class="highlighter-rouge">.false.</code><span>) described in the previous chapters in that the state variables for the last time step of the simulation, including wavefields of the displacement, velocity, acceleration, etc., are saved to the </span><code class="highlighter-rouge">LOCAL_PATH</code><span> to be used for the subsequent simulation. </span></p>
      </li>
      <li>
        <p>For regional simulations, the files recording the absorbing boundary contribution are also written to the <code class="highlighter-rouge">LOCAL_PATH</code> when <code class="highlighter-rouge">SAVE_FORWARD = .true.</code>.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Prepare the adjoint sources</strong></p>

    <p>The adjoint sources need to be prepared the same way as described in the Section [enu:Prepare-the-adjoint].</p>

    <ul>
      <li>
        <p>In the case of travel-time finite-frequency kernel for one source-receiver pair, i.e., point source from the <code class="highlighter-rouge">CMTSOLUTION</code>, and one station in the <code class="highlighter-rouge">STATIONS_ADJOINT</code> list, we supply a sample program in <code class="highlighter-rouge">utils/adjoint_sources/traveltime/xcreate_adjsrc_traveltime</code> to cut a certain portion of the original displacement seismograms and convert it into the proper adjoint source to compute the finite-frequency kernel.</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>xcreate_adjsrc_traveltime t1 t2 ifile[0-5] E/N/Z-ascii-files [baz]
</code></pre>
        </div>

        <p>where <code class="highlighter-rouge">t1</code> and <code class="highlighter-rouge">t2</code> are the start and end time of the portion you are interested in, <code class="highlighter-rouge">ifile</code> denotes the component of the seismograms to be used (0 for all three components, 1 for East, 2 for North, and 3 for vertical, 4 for transverse, and 5 for radial component), <code class="highlighter-rouge">E/N/Z-ascii-files</code> indicate the three-component displacement seismograms in the right order, and <code class="highlighter-rouge">baz</code> is the back-azimuth of the station. Note that <code class="highlighter-rouge">baz</code> is only supplied when <code class="highlighter-rouge">ifile</code> = 4 or 5.</p>
      </li>
      <li>
        <p>Similarly, a sample program to compute adjoint sources for amplitude finite-frequency kernels may be found in <code class="highlighter-rouge">utils/adjoint_sources/amplitude</code> and used in the same way as described for traveltime measurements</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>xcreate_adjsrc_amplitude t1 t2 ifile[0-5] E/N/Z-ascii-files [baz]
</code></pre>
        </div>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Run the kernel simulation</strong></p>

    <p>With the successful forward simulation and the adjoint source ready in the <code class="highlighter-rouge">SEM/</code> directory, set <code class="highlighter-rouge">SIMULATION_TYPE = 3</code> and <code class="highlighter-rouge">SAVE_FORWARD = .false.</code> in the <code class="highlighter-rouge">Par_file</code> (you can use <code class="highlighter-rouge">change_simulation_type.pl -b</code>), and rerun the solver.</p>

    <ul>
      <li>
        <p>The adjoint simulation is launched together with the back reconstruction of the original forward wavefield from the state variables saved from the previous forward simulation, and the finite-frequency kernels are computed by the interaction of the reconstructed forward wavefield and the adjoint wavefield.</p>
      </li>
      <li>
        <p>The back-reconstructed seismograms at the original station locations are saved to the <code class="highlighter-rouge">LOCAL_PATH</code> at the end of the kernel simulations, and can be collected to the local disk.</p>
      </li>
      <li>
        <p>These back-constructed seismograms can be compared with the time-reversed original seismograms to assess the accuracy of the backward reconstruction, and they should match very well.</p>
      </li>
      <li>
        <p>The arrays for density, P-wave speed and S-wave speed kernels are also saved in the <code class="highlighter-rouge">LOCAL_PATH</code> with the names <code class="highlighter-rouge">proc??????_rho(alpha,beta)_kernel.bin</code>, where <code class="highlighter-rouge">proc??????</code> represents the processor number, <code class="highlighter-rouge">rho(alpha,beta)</code> are the different types of kernels.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Run the anisotropic kernel simulation</strong></p>

    <p>Instead of the kernels for the isotropic wave speeds, you can also compute the kernels for the 21 independent components (C_{IJ},\, I,J=1,…,6) (using Voigt’s notation) of the elastic tensor in the cartesian coordinate system. This is done by setting <code class="highlighter-rouge">ANISOTROPIC_KL</code> <code class="highlighter-rouge">=</code> <code class="highlighter-rouge">.true.</code> in <code class="highlighter-rouge">constants.h</code> before compiling the package. The definition of the parameters (C_{IJ}) in terms of the corresponding components (c_{ijkl},ijkl,i,j,k,l=1,2,3) of the elastic tensor in cartesian coordinates follows Chen and Tromp (2007). The 21 anisotropic kernels are saved in the <code class="highlighter-rouge">LOCAL_PATH</code> in one file with the name of <code class="highlighter-rouge">proc??????_cijkl_kernel.bin</code> (with <code class="highlighter-rouge">proc??????</code> the processor number). The output kernels correspond to absolute perturbations (\delta C_{IJ}) of the elastic parameters and their unit is in (s/GPa/km^{3}). For consistency, the output density kernels with this option turned on are for a perturbation (\delta\rho) (and not (\frac{\delta\rho}{\rho})) and their unit is in s / (kg/m(^{3})) / km(^{3}). These ‘primary’ anisotropic kernels can then be combined to obtain the kernels for different parameterizations of anisotropy. This can be done, for example, when combining the kernel files from slices into one mesh file (see Section [sec:Finite-Frequency-Kernels]).</p>

    <p>If <code class="highlighter-rouge">ANISOTROPIC_KL</code> <code class="highlighter-rouge">=</code> <code class="highlighter-rouge">.true.</code> by additionally setting <code class="highlighter-rouge">ANISOTROPIC_KL</code> <code class="highlighter-rouge">=</code> <code class="highlighter-rouge">.true.</code> in <code class="highlighter-rouge">constants.h</code> the package will save anisotropic kernels parameterized as velocities related to transverse isotropy based on the the Chen and Tromp parameters Chen and Tromp (2007). The kernels are saved as relative perturbations for horizontal and vertical P and S velocities, (\alpha_{v},\alpha_{h},\beta_{v},\beta_{h}). Explicit relations can be found in appendix B. of Sieminski et al. (2007)</p>

    <p>The anisotropic kernels are only currently available for CPU mode.</p>
  </li>
</ol>

<p>In general, the three steps need to be run sequentially to assure proper access to the necessary files. If the simulations are run through some cluster scheduling system (e.g., LSF), and the forward simulation and the subsequent kernel simulations cannot be assigned to the same set of computer nodes, the kernel simulation will not be able to access the database files saved by the forward simulation. Solutions for this dilemma are provided in Chapter [cha:Scheduler]. Visualization of the finite-frequency kernels is discussed in Section [sec:Finite-Frequency-Kernels].</p>

<h2 id="references">References</h2>

<p>Chen, Min, and Jeroen Tromp. 2007. “Theoretical and Numerical Investigations of Global and Regional Seismic Wave Propagation in Weakly Anisotropic Earth Models.” <em>Geophys. J. Int.</em> 168 (3): 1130–52. doi:<a href="http://dx.doi.org/10.1111/j.1365-246X.2006.03218.x">10.1111/j.1365-246X.2006.03218.x</a>.</p>

<p>Liu, Q., and J. Tromp. 2008. “Finite-Frequency Sensitivity Kernels for Global Seismic Wave Propagation Based Upon Adjoint Methods.” <em>Geophys. J. Int.</em> 174 (1): 265–86. doi:<a href="http://dx.doi.org/10.1111/j.1365-246X.2008.03798.x">10.1111/j.1365-246X.2008.03798.x</a>.</p>

<p>Liu, Qinya, and Jeroen Tromp. 2006. “Finite-Frequency Kernels Based on Adjoint Methods.” <em>Bull. Seism. Soc. Am.</em> 96 (6): 2383–97. doi:<a href="http://dx.doi.org/10.1785/0120060041">10.1785/0120060041</a>.</p>

<p>Sieminski, Anne, Qinya Liu, Jeannot Trampert, and Jeroen Tromp. 2007. “Finite-Frequency Sensitivity of Body Waves to Anisotropy Based Upon Adjoint Methods.” <em>Geophys. J. Int.</em> 171: 368–89. doi:<a href="http://dx.doi.org/10.1111/j.1365-246X.2007.03528.x">10.1111/j.1365-246X.2007.03528.x</a>.</p>

<p>Tromp, Jeroen, Dimitri Komatitsch, and Qinya Liu. 2008. “Spectral-Element and Adjoint Methods in Seismology.” <em>Communications in Computational Physics</em> 3 (1): 1–32.</p>

<p>Tromp, Jeroen, Carl Tape, and Qinya Liu. 2005. “Seismic Tomography, Adjoint Methods, Time Reversal and Banana-Doughnut Kernels.” <em>Geophys. J. Int.</em> 160 (1): 195–216. doi:<a href="http://dx.doi.org/10.1111/j.1365-246X.2004.02453.x">10.1111/j.1365-246X.2004.02453.x</a>.</p>

<p>Wald, D. J., and T. H. Heaton. 1994. “Spatial and Temporal Distribution of Slip for the 1992 Landers, California Earthquake.” <em>Bull. Seism. Soc. Am.</em> 84: 668–91.</p>

<hr />
<blockquote>
  <p>This documentation has been automatically generated by <a href="http://www.pandoc.org">pandoc</a>
based on the User manual (LaTeX version) in folder doc/USER_MANUAL/
(Mar 10, 2020)</p>
</blockquote>


    </section>

    <section class="page-footer">
      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="http://github.com/danielpeter/specfem3d">specfem3d</a> is maintained by <a href="http://github.com/danielpeter">danielpeter</a></span>
        
        <span class="site-footer-credits">generated by <a href="https://pages.github.com">GitHub Pages</a></span>
      </footer>
    </section>

    
  </body>
</html>
